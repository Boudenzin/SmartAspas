% smartaspas.sty (v1.2.1)
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{smartaspas}[2025/09/17 v1.2.1 Aspas automáticas robustas]

% Dependências
\RequirePackage{kvoptions}
\RequirePackage{etoolbox}
\RequirePackage{csquotes}

% ===== Opções =====
\SetupKeyvalOptions{
  family=smartaspas,
  prefix=sa@
}
\DeclareStringOption[auto]{language}
\DeclareBoolOption[true]{activate}  % ativa \MakeOuterQuote + \EnableQuotes
\DeclareBoolOption[true]{nested}    % ativa aspas secundárias
\DeclareStringOption[]{safeenv}     % lista csv de ambientes "seguros"
\ProcessKeyvalOptions*

% ===== Lógica central =====

% Aplica o estilo de aspas conforme a linguagem
\newcommand*\sa@applylanguage[1]{%
  % normaliza alguns aliases comuns
  \def\sa@lang{#1}%
  \ifdefstring{\sa@lang}{portuguese}{\def\sa@lang{brazil}}{}%
  %
  \ifstrequal{\sa@lang}{brazil}{%
    \MakeAutoQuote{“}{”}%
    \ifsa@nested\MakeAutoQuote*{‘}{’}\fi
  }{%
    \ifstrequal{\sa@lang}{french}{%
      % Se preferir deixar o espaçamento ao babel/polyglossia, use só «» e ‹›:
      \MakeAutoQuote{«}{»}%
      \ifsa@nested\MakeAutoQuote*{‹}{›}\fi
    }{%
      % english (fallback)
      \ifstrequal{\sa@lang}{english}{}{%
        \PackageWarning{smartaspas}{Idioma '\sa@lang' nao reconhecido; usando 'english' como fallback}%
      }%
      \MakeAutoQuote{“}{”}%
      \ifsa@nested\MakeAutoQuote*{‘}{’}\fi
    }%
  }%
}

% Ativa/desativa sistema de aspas automáticas
\newcommand*\sa@configureactivate{%
  \ifsa@activate
    \MakeOuterQuote{"}%
    \EnableQuotes
  \else
    \DisableQuotes
    % Nao tentar "restaurar" catcode do " aqui: evite mexer em catcodes dinamicamente.
  \fi
}

% Desativar quotes em ambientes nomeados (além do que csquotes já trata)
\newcommand*\sa@DisableQuotesIn[1]{%
  \AtBeginEnvironment{#1}{\DisableQuotes}%
  \AtEndEnvironment{#1}{\EnableQuotes}%
}

% ===== Hooks e Configuração Inicial =====
\makeatletter
\AtBeginDocument{%
  % 1) Determina o idioma
  \ifdefstring{\sa@language}{auto}{%
    \@ifpackageloaded{babel}{%
      % mapeia \languagename de forma simples
      \edef\sa@guess{english}%
      \ifstrequal{\languagename}{brazil}{\edef\sa@guess{brazil}}{}%
      \ifstrequal{\languagename}{portuguese}{\edef\sa@guess{brazil}}{}%
      \ifstrequal{\languagename}{french}{\edef\sa@guess{french}}{}%
      \sa@applylanguage{\sa@guess}%
    }{%
      \@ifpackageloaded{polyglossia}{%
        \edef\sa@guess{english}%
        \ifstrequal{\languagename}{brazil}{\edef\sa@guess{brazil}}{}%
        \ifstrequal{\languagename}{portuguese}{\edef\sa@guess{brazil}}{}%
        \ifstrequal{\languagename}{french}{\edef\sa@guess{french}}{}%
        \sa@applylanguage{\sa@guess}%
      }{%
        \PackageWarning{smartaspas}{Nenhum pacote de idioma detectado e language=auto; usando 'english' como padrao}%
        \sa@applylanguage{english}%
      }%
    }%
  }{%
    \sa@applylanguage{\sa@language}%
  }%

  % 2) Ativa " como atalho se pedido
  \sa@configureactivate

  % 3) Ambientes seguros adicionais
  \ifdefempty{\sa@safeenv}{}{%
    \forcsvlist{\sa@DisableQuotesIn}{\sa@safeenv}%
  }%
}
\makeatother

% ===== API pública =====

% Liga/desliga globalmente (respeita Activate ligado)
\newcommand{\smartaspasOn}{\EnableQuotes}
\newcommand{\smartaspasOff}{\DisableQuotes}

% Ambientes locais (nao vazam estado)
\newenvironment{smartaspasoff}{\begingroup\DisableQuotes}{\endgroup}
\newenvironment{smartaspason}{\begingroup\EnableQuotes}{\endgroup}

% Aspas explícitas
\newcommand{\aspas}[1]{\enquote{#1}}
\newcommand{\aspasSimples}[1]{\textquote{#1}}

% Reconfiguração dinâmica
\newcommand{\SmartAspasSetup}[1]{%
  \setkeys{smartaspas}{#1}%
  \sa@applylanguage{\sa@language}%
  \sa@configureactivate
}

\endinput
